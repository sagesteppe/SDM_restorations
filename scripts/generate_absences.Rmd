---
title: "Generate Real and Pseudo-absences"
author: "steppe"
date: "2023-12-06"
output: html_document
---

```{r load packages}
library(tidyverse)
library(sf)
source('functions.R')
```

```{r Create simplified BLM surface management, eval = F}
p1 <- '/media/steppe/hdd/geospatial/SMA_WM.gdb'

st_layers(p1)
ag <- st_read(p1, 'SurfaceMgtAgy_BLM') %>% 
  filter(ADMIN_ST != 'AK') %>% 
  rename(geometry = SHAPE) %>% 
  select(geometry) %>% 
  st_make_valid() %>% 
  st_union()

ag <- st_simplify(ag, dTolerance = 1000)
plot(ag)

pout <- '/media/steppe/hdd/SDM_restorations/data/raw/coarse_blm/'
st_write(ag, dsn = paste0(pout, 'coarse_surface.shp'))
```

We use absences while creating species distribution models. 
Both true absences, acquired from vegetation monitoring plots, and pseudo absences generated via geographic and environmental space are used. 

```{r load aim data for absences, eval = F}

p  <- '../data/raw/2021_AIM_Terrestrial/AIMTerrestrial9-1-22.gdb'
AIM_points <- st_read(dsn = p, layer = 'TerrADat', quiet = T) %>%
  select(PrimaryKey, DateVisited, geometry = Shape) %>% 
  st_transform(5070) 

pout <- '/media/steppe/hdd/SDM_restorations/data/raw/coarse_blm/'
blm_surf <- st_read(paste0(pout, 'coarse_surface.shp'), quiet = TRUE)
blm_surf <- st_simplify(blm_surf, dTolerance = 500) # just make it a bit smaller. 
blm_surf <- st_make_valid(blm_surf)
```

```{r generate raw absences, eval = F}

records <- st_read('../data/raw/occurrence/thinned/thinned_occurrences.shp', quiet = TRUE)
records <- records %>% 
  group_by(taxon) %>% 
  filter(n() >= 15)
records <- split(records, f = records$taxon)

out <- lapply(records, absence_drawer, bg_abs = 0.15)
out <- bind_rows(out)
st_write(out, '../data/raw/occurrence/absences.shp')
```



