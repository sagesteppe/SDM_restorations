---
title: "Results"
author: "steppe"
date: "2024-08-12"
output: pdf_document
---


```{r load libraries}
library(tidyverse)
library(sf)
library(terra)
```

## Import and prepare data for analysis. 

```{r Subset to relevant species}
scouting <- read.csv('../data/SOS/Scouting.csv') |>
  mutate(taxa = gsub(' ', '_', taxa)) |>
  select(c(1:10, 22, 23)) |>
  filter(taxa != 'Achnatherum_hymenoides')

f <- list.files('../results/suitability_maps')
f <- f[ str_detect(f, '1k')]

f <- data.frame(
  f_suitability = paste0('../results/suitability_maps/', f), 
  species = gsub('1k-.*', '', f)
) 

scouting <- filter(scouting, taxa %in% f$species) |>
  sf::st_as_sf(coords = c('LONGITUDE_DECIMAL', 'LATITUDE_DECIMAL'), crs = 4326) |>
  st_transform(5070)

# here are the ranked patches
f_rp <- list.files('../results/rankedPatches', pattern = '.shp')
f_rp <- data.frame(
  f_rankedp = paste0('../results/rankedPatches/', f_rp), 
  species = gsub('[.]shp$', '', f_rp)
)

f_pm <- list.files('../results/patch_metrics')
f_pm <- data.frame(
  f_patchMetrics = paste0('../results/patch_metrics/', f_pm[grepl('patch', f_pm)]), 
  f_classMetrics = paste0('../results/patch_metrics/', f_pm[grepl('class', f_pm)]) 
) |>
  mutate(species = gsub('-.*$', '', basename(f_patchMetrics)))

files <- left_join(f, f_rp, by = 'species') |>
  left_join(f_pm, by = 'species') |>
  relocate(species, .before = 1) |>
  filter(species %in% scouting$taxa) 

rm(f, f_rp, f_pm)
```


```{r Extract Values to Results}

scouting <- left_join(scouting, files, by = c('taxa' = 'species')) |>
  mutate(Presence = if_else(POPULATION_SIZE > 0, 1, 0), .after = POPULATION_SIZE)

scout_split <- split(scouting, scouting$taxa)
# we are going to discard species with fewer than 3 observations. 
scout_split <- scout_split[lapply(scout_split, nrow) >= 3]

#' return predicted suitability scores and patch ID's for scouting points
#' 
#' Use this function to return some modeled values from scouting points observations
#' @param x an sf/tibble/data frame split by species, and including columns with 
#' paths to required files. 
extractR <- function(x){ 
  
  suitability <- terra::rast(sf::st_drop_geometry(x$f_suitability[1]))
  patch_ranks <- sf::st_read(sf::st_drop_geometry(x$f_rankedp[1]), quiet = T)
  
  x <- sf::st_join(x, patch_ranks)
  suitability <- terra::extract(suitability, x)$predicted_suitability
  
  wide <- dplyr::mutate(
    x, 
    suitability = suitability, 
    .before = geometry) |>
    select(-f_suitability, -f_rankedp)
    
  # now we can join the class and patch metrics to each population 
  # which they were calculated for. 
  IDs <- tidyr::drop_na(wide, PchIDComb) |>
    dplyr::pull(PchIDComb)
  patch <- read.csv(sf::st_drop_geometry(x$f_patchMetrics[1]) ) |>
    dplyr::filter(id %in% IDs) |>
   # dplyr::rename(patch_metric = metric, patch_value = value) |>
    tidyr::pivot_wider(values_from = value, names_from = metric)
  class <- read.csv(sf::st_drop_geometry(x$f_classMetrics[1])) |>
    tidyr::pivot_wider(names_from = metric, values_from = value)
  
  ob <- cbind(patch, class)

  return(ob)
  
} 

scouting <- lapply(scout_split[1], extractR)
scouting <- dplyr::bind_rows(scouting)

scouting[[1]] |> 
    tidyr::pivot_wider(names_from = metric, values_from = value)

rm(files)
```


## Determine which points were used in training the models

These points will need to be removed because they are already known to be presences... 


## Analysis 

1) What is the relationship between habitat suitability and presence of species? 

```{r}

fp <- scout1[scouting$futurePotential=='Yes',] 

quants <- quantile(fp$suitability, na.rm = TRUE, probs = c(0.25, 0.5, 0.75))
hist(fp$suitability)
abline(v = quants[[1]], lwd = 2)
abline(v = quants[[2]], lwd = 2)
abline(v = quants[[3]], lwd = 2)

```
```{r}
quants
```

2) What is the relationship between Patch Rank and presence of species? 

```{r}
hist(fp$Rank)
```

3) What is the relationship between Patch metrics and presence of species? 

```{r}

```


The second main part relates to population size 

4) What is the relationship between habitat suitability and population size? 
```{r}
scout1 <- mutate(
  scout1, 
  taxa = as.factor(taxa), 
  COLL_ID = as.factor(COLL_ID))

plot(scout1$suitability, scout1$POPULATION_SIZE)

m <- lm(POPULATION_SIZE ~ suitability + taxa, data = scout1)
summary(m)

pois.mod <- lme4::glmer(POPULATION_SIZE ~ suitability + (1 | taxa), data = scout1, family = poisson)
summary(pois.mod)
anova(pois.mod)

pois.mod_int <- lme4::glmer(POPULATION_SIZE ~ suitability + (1 + suitability|taxa), data = scout1, family = poisson)
summary(pois.mod_int)

plot(pois.mod_int)
plot(residuals(pois.mod_int))

qqnorm(resid(pois.mod_int))# QQ-plot
qqline(resid(pois.mod_int))

AIC(pois.mod, pois.mod_int)
anova(pois.mod, pois.mod_int)
```

4) What is the relationship between patch metrics and population size? 
```{r}

```



