---
title: "Results"
author: "steppe"
date: "2024-08-12"
output: pdf_document
---


```{r load libraries}
library(tidyverse)
library(sf)
library(terra)
```

## Import and prepare data for analysis. 

```{r Subset to relevant species}
scouting <- read.csv('../data/SOS/Scouting.csv') |>
  mutate(taxa = gsub(' ', '_', taxa)) |>
  select(c(1:10, 22, 23)) |>
  filter(taxa != 'Achnatherum_hymenoides')

f <- list.files('../results/suitability_maps')
f <- f[ str_detect(f, '1k')]

f <- data.frame(
  f_suitability = paste0('../results/suitability_maps/', f), 
  species = gsub('1k-.*', '', f)
) 

scouting <- filter(scouting, taxa %in% f$species) |>
  sf::st_as_sf(coords = c('LONGITUDE_DECIMAL', 'LATITUDE_DECIMAL'), crs = 4326) |>
  st_transform(5070)

# here are the ranked patches
f_rp <- list.files('../results/rankedPatches', pattern = '.shp')
f_rp <- data.frame(
  f_rankedp = paste0('../results/rankedPatches/', f_rp), 
  species = gsub('[.]shp$', '', f_rp)
)

f_pm <- list.files('../results/patch_metrics')
f_pm <- data.frame(
  f_patchMetrics = paste0('../results/patch_metrics/', f_pm[grepl('patch', f_pm)]), 
  f_classMetrics = paste0('../results/patch_metrics/', f_pm[grepl('class', f_pm)]) 
) |>
  mutate(species = gsub('-.*$', '', basename(f_patchMetrics)))

files <- left_join(f, f_rp, by = 'species') |>
  left_join(f_pm, by = 'species') |>
  relocate(species, .before = 1) |>
  filter(species %in% scouting$taxa) 

rm(f, f_rp, f_pm)
```


```{r Extract Values to Results}

scouting <- left_join(scouting, files, by = c('taxa' = 'species')) |>
  mutate(Presence = if_else(POPULATION_SIZE > 0, 1, 0), .after = POPULATION_SIZE)

scout_split <- split(scouting, scouting$taxa)
# we are going to discard species with fewer than 3 observations. 
scout_split <- scout_split[lapply(scout_split, nrow) >= 3]

#' return predicted suitability scores and patch ID's for scouting points
#' 
#' Use this function to return some modeled values from scouting points observations
#' @param x an sf/tibble/data frame split by species, and including columns with 
#' paths to required files. 
extractR <- function(x){ 
  
  suitability <- terra::rast(sf::st_drop_geometry(x$f_suitability[1]))
  patch_ranks <- sf::st_read(sf::st_drop_geometry(x$f_rankedp[1]), quiet = T)
  
  x <- sf::st_join(x, patch_ranks)
  suitability <- terra::extract(suitability, x)$predicted_suitability
    
  # now we can join the class and patch metrics to each population 
  # which they were calculated for. 
  IDs <- tidyr::drop_na(x, PchIDComb) |>
    dplyr::pull(PchIDComb)
  
  patch <- read.csv(sf::st_drop_geometry(x$f_patchMetrics[1]) ) |>
    dplyr::filter(id %in% IDs) |>
    tidyr::pivot_wider(values_from = value, names_from = metric)
  class <- read.csv(sf::st_drop_geometry(x$f_classMetrics[1])) |>
    tidyr::pivot_wider(names_from = metric, values_from = value)
  
  if(nrow(patch) == 0){
    patch <- data.frame(id = NA, cai = NA, enn = NA, frac = NA, para = NA )
  }
  
  lsm <- cbind(patch, class) |>
    dplyr::mutate(id = as.character(id))

  wide <- dplyr::mutate(
    x, 
    suitability = suitability, 
    .before = geometry) |>
    dplyr::select(-f_suitability, -f_rankedp, -f_patchMetrics, -f_classMetrics) |>
    dplyr::left_join(lsm, by = c('PchIDComb' = 'id' ))
  
  return(wide)
  
} 

scouting <- lapply(scout_split, extractR)
scouting <- dplyr::bind_rows(scouting)

```


```{r determine a null model for each species, eval = F}
#' return a large sample from a raster to plot the amount of suitable habitat 
#' 
#' sample many rasters to make a plot showing the cumulative amount of suitable habitat
#' @param x a data frame split by species including columns with paths to files. 
prcntSuitable <- function(x){
  
  r <- terra::rast(sf::st_drop_geometry(x$f_suitability[1]))
  Suitability = spatSample(r, size = 50000, na.rm = TRUE)
  q <- quantile(Suitability$predicted_suitability, probs = seq(0.01, 1, 0.01))
  
  sample <- 
    data.frame(
      Species = sf::st_drop_geometry(x$taxa[1]), 
      Percent = 1:100, 
      Records = as.numeric(q)
    )
  
  return(sample)
  
}

suitability_amounts <- lapply(scout_split, prcntSuitable)
saveRDS(suitability_amounts, file = '../data/processed/prcntSDMsurfaceSuitable.rds')
```


```{r}

suitability_amounts <- readRDS('../data/processed/prcntSDMsurfaceSuitable.rds')
suitability_amounts <- bind_rows(suitability_amounts)

suitability_means <- suitability_amounts |>
  group_by(Percent) |>
  summarise(Mean = mean(Records))

par(pty="s")
plot(suitability_means$Mean, suitability_means$Percent, type = "l", col = "red", 
     ylab = "% of all Raster Cells", xlab = "Cumulative Sum of Records at each Predicted Suitability")


ggplot(suitability_amounts, aes(Percent, Records, color = Species, group = Species)) +
  geom_line() +
  scale_color_grey(guide = 'none') + 
  geom_line(data = suitability_means, 
            aes(Percent, Mean), inherit.aes = F, color = '#093824', lwd = 1) + 
  labs(
    y = "% of all Raster Cells",
    x = 'Cumulative sum of records at each quantile of Predicted Suitability') + 
  theme_classic() +
  theme(aspect.ratio = 1/1)
  


'#292E1E'
'#1F271B'
'#003E1F'
'#003E1F'
'#093824'
'#04471C'
'#1F2F16'
'#137547'
'#2A9134'

'#254441'
'#395B50'
'#73BA9B'
'#519872'

rm(files)
```


## Determine which points were used in training the models

These points will need to be removed because they are already known to be presences... 


## Analysis 

1) What is the relationship between habitat suitability and presence of species? 

```{r}

fp <- scout1[scouting$futurePotential=='Yes',] 

quants <- quantile(fp$suitability, na.rm = TRUE, probs = c(0.25, 0.5, 0.75))
hist(fp$suitability)
abline(v = quants[[1]], lwd = 2)
abline(v = quants[[2]], lwd = 2)
abline(v = quants[[3]], lwd = 2)

```


```{r}
quants
```

2) What is the relationship between Patch Rank and presence of species? 

```{r}
hist(fp$Rank)
```

3) What is the relationship between Patch metrics and presence of species? 

```{r}

```


The second main part relates to population size 

4) What is the relationship between habitat suitability and population size? 
```{r}
scout1 <- mutate(
  scout1, 
  taxa = as.factor(taxa), 
  COLL_ID = as.factor(COLL_ID))

plot(scout1$suitability, scout1$POPULATION_SIZE)

m <- lm(POPULATION_SIZE ~ suitability + taxa, data = scout1)
summary(m)

pois.mod <- lme4::glmer(POPULATION_SIZE ~ suitability + (1 | taxa), data = scout1, family = poisson)
summary(pois.mod)
anova(pois.mod)

pois.mod_int <- lme4::glmer(POPULATION_SIZE ~ suitability + (1 + suitability|taxa), data = scout1, family = poisson)
summary(pois.mod_int)

plot(pois.mod_int)
plot(residuals(pois.mod_int))

qqnorm(resid(pois.mod_int))# QQ-plot
qqline(resid(pois.mod_int))

AIC(pois.mod, pois.mod_int)
anova(pois.mod, pois.mod_int)
```

4) What is the relationship between patch metrics and population size? 
```{r}

scout_long <- pivot_longer(scouting, cai:enn_mn)

ggplot(scout_long, aes(y = POPULATION_SIZE, x = value)) +
  geom_point() +
  facet_grid(. ~ name) 

```



