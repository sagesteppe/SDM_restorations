---
title: "detect patches"
author: "steppe"
date: "2024-01-22"
output: html_document
---

```{r}
library(terra)
```

```{r}
p <- '../results/suitability_maps'
r <- rast(file.path(p, 'Achnatherum_aridum1k-2024-01-10_09:16:55.tif'))
msk <- ifel(r < 0.80, NA, r)
m <- mask(r, msk)
m1 <- aggregate(m, 2, fun = 'mean')

# aggregate the raster to speed up the patch detection process. 
```

aggregation by a factor of 2 allows for quick patch delineation and detection. 

```{r}
system.time({ob <- terra::patches(m1,  directions = 4)})
system.time({z =  zonal(cellSize(ob, unit="ha"), ob, sum, as.raster=TRUE) })
z = ifel(z < 2.0235, NA, z)

plot(z)
```


```{r Patch metics to predict presence}

# euclidean nearest neighbor distance (enn) - (Patch)
## (modification) log(enn), sqrt(enn)
### Expectation: the number of colonized predicted patches decrease with increasing distance.
#### why: long-distance dispersal is limited from colonized to suitable patches. 
##### test: glm(colonization(0|1) ~ enn,  family = binomial)

# nearest neighbor distance (enn_mn) - (Class) # note other method of aggregation can be used too!
## (modification) log(enn_mn), sqrt(enn_mn)
### Expectation: the number of colonized predicted patches increases with increasing distance.
#### why: this species is adept at long distance dispersal
##### test: glm(colonization(0|1) ~ enn_mn,  family = binomial)
```


```{r Patch metrics to predict abundance}
# library(landscapemetrics)

# Patch level metrics. 
print(
  landscapemetrics::list_lsm(level = "class"))

# Core Area Index (cai)  
## (modification) arithmetic mean of core area cells
### Expectation: higher cai higher abundance
#### why: better within patch distribution, and a persistent 'source' to 'sink' peripheral cells. 
##### test: glmm?(% cover ~ cai, correlation = nlme::corExp(Long ~ Lat, nugget=T), family = quasibinomial)

# perimeter-area ratio (para)
## (modification) none
### Expectation: lower para higher abundance
#### why: areas with 'large edges' will suffer dispersal limitations throughout them, as many seeds will go to unsuitable habitat.
##### test: glmm?(% cover ~ para, correlation = nlme::corExp(Long ~ Lat, nugget=T), family = quasibinomial)

# fractal dimension index (frac)
## (modification) none
### Expectation: lower fractal dimensions (less complex patch shapes) have higher abundances. 
#### why: components of patches with complex shapes may suffer dispersal limitation. 
##### test: glmm?(% cover ~ frac, correlation = nlme::corExp(Long ~ Lat, nugget=T), family = quasibinomial)

## to all models a term for the previous 4 years SPEI may be incorporated. 

```
