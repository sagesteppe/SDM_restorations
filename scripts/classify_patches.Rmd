---
title: "detect patches"
author: "steppe"
date: "2024-01-22"
output: html_document
---

```{r}
library(terra)
library(landscapemetrics)
```

Create coarse patches for 'meta-populations'

```{r}

p <- '../results/suitability_maps'
f <- file.path(p, list.files(p, pattern = '1k-'))

gd <- '/media/steppe/hdd/Geospatial_data'
hydr_bound <- rast( file.path(gd, 'WBD_rast', 'hu10R-line.tif') )
hydr_ftr <-  rast( file.path(gd, 'river_resistance', 'water_ftR.tif') )
rm(gd)


lapply(f, patcheR) # roughly 72 hours. 

```




```{r}

abvi <- rast('../results/patches/Abronia_villosa.tif')

gd <- '/media/steppe/hdd/Geospatial_data'
hydr_bound <- rast( file.path(gd, 'WBD_rast', 'hu10R-line.tif') )


landscapR <- function(x, pout, pRout){

  x <- terra::ifel(x > 0.75, 1, NA)
  x <- terra::mask(x, f_wbd, inverse = TRUE)
  landscape <- landscapemetrics::get_patches(x, directions = 4)
  calcs <- landscapemetrics::calculate_lsm(x, what = c('lsm_c_enn_mn', 'lsm_c_enn_cv',
                "lsm_p_enn", "lsm_p_enn", "lsm_p_cai", "lsm_p_para", "lsm_p_frac"), 
              neighbourhood = 4, directions = 4)

  p <- '../results/'
  write.csv(
    calcs[calcs$level == 'patch', c('id', 'metric', 'value')],
    filename = paste0(p, pout, '/', taxon, '-', 'patch_vals.csv'),  row.names = F
  )

  write.csv(
    calcs[calcs$level == 'class', c('id', 'metric', 'value')],
    filename = paste0(p, pout, '/', taxon, '-', 'class_vals.csv'), row.names = F
  )

  writeRaster(landscape[["layer_1"]][["class_1"]], 
    filename = paste0(p, pRout, '/', taxon, '-', 'patchIDS.tif')
  )

}

landscapR(f, pout = 'patch_metrics', pRout = 'fine_patches')

```


```{r Patch metics to predict presence}

# euclidean nearest neighbor distance (enn) - (Patch) {lsm_p_enn}
## (modification) log(enn), sqrt(enn)
### Expectation: the number of colonized predicted patches decrease with increasing distance.
#### why: long-distance dispersal is limited from colonized to suitable patches. 
##### test: glm(colonization(0|1) ~ enn,  family = binomial)

# nearest neighbor distance (enn_mn) - (Class) {lsm_c_enn_mn} # note other method of aggregation can be used too!
## (modification) log(enn_mn), sqrt(enn_mn)
### Expectation: the number of colonized predicted patches increases with increasing distance.
#### why: this species is adept at long distance dispersal
##### test: glm(colonization(0|1) ~ enn_mn,  family = binomial)


```


```{r Patch metrics to predict abundance}
# library(landscapemetrics)

# Patch level metrics. 
print(
  landscapemetrics::list_lsm(level = "class"))


# Core Area Index (cai)  {lsm_p_cai}
## (modification) arithmetic mean of core area cells
### Expectation: higher cai higher abundance
#### why: better within patch distribution, and a persistent 'source' to 'sink' peripheral cells. 
##### test: glmm?(% cover ~ cai, correlation = nlme::corExp(Long ~ Lat, nugget=T), family = quasibinomial)

# perimeter-area ratio (para) {lsm_p_para}
## (modification) none
### Expectation: lower para higher abundance
#### why: areas with 'large edges' will suffer dispersal limitations throughout them, as many seeds will go to unsuitable habitat.
##### test: glmm?(% cover ~ para, correlation = nlme::corExp(Long ~ Lat, nugget=T), family = quasibinomial)

# fractal dimension index (frac) {lsm_p_frac}
## (modification) none
### Expectation: lower fractal dimensions (less complex patch shapes) have higher abundances. 
#### why: components of patches with complex shapes may suffer dispersal limitation. 
##### test: glmm?(% cover ~ frac, correlation = nlme::corExp(Long ~ Lat, nugget=T), family = quasibinomial)

## to all models a term for the previous 4 years SPEI may be incorporated. 

```
