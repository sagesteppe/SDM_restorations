---
title: "Clean Records"
author: "steppe"
date: "2023-12-04"
output: html_document
---

Here we perform a number of steps which we use to ensure that the records going into the modelling process are as clean as can be. 


Species vary in their responses to disturbances such as fire. 
More importantly, ecosystems differ in their responses to fire based both upon intrinisic characteristics, but especially land management history. 
Many species are unable to recover post wildfire in the West due to the rapid increase in cover of inasive annuals, especially grasses such as Cheatgrass and Medusa-Head. 
Using the NFIC fire perimeters data set, we flag each record which has experienced a wild lands burn, and determine which AIM plots have been located in burn scars.

To do this, we first (1) identify all AIM plots with presences of the species. 
We then (2) combine the plot based and plot-free occurrence data to create occurrence data set. 
3) All remaining AIM plots within 5 miles of the occurrence data set, and within 10% of the range of all environmental variables are identified. 
4) These remaining AIM plots without presences are coded as absences, and used as '0' for the records. 

```{r load libraries}
library(tidyverse)
library(sf)
library(terra)
library(leaflet)
source('functions.R')
```


```{r Import Predictor Stack}

p <- '/media/steppe/hdd/Geospatial_data/WesternPlantPredictors2/chelsa/bio12'
files <- file.path(p, list.files(p, recursive = TRUE))

# bio10 <- vrt(files)
# bio1 <- vrt(files)
# bio12 <- vrt(files)
# bio4 <- vrt(files)
# bio19 <- vrt(files)
names(bio1) <- 'bio1'
names(bio10) <- 'bio10'
names(bio12) <- 'bio12'
names(bio4) <- 'bio4'
names(bio19) <- 'bio19'

bio <- c(bio1, bio10, bio12, bio4, bio19)

filter(thinned, str_detect(taxon, '^L')) |> 
  pull(taxon) |> 
  unique() 

rm(bio1, bio10, bio12, bio4, bio19)
```

```{r}
pts1 <- filter(thinned, taxon == 'Leymus cinereus')
bio_v <- extract(bio, pts1)
bio_v1 <- bind_cols(bio_v, pts1) %>% 
  st_as_sf() 

OUTPUT <- quantile_flagger(bio_v1, 0.015, flag_threshold = 0.2) %>% 
  st_transform(4326) %>% 
  mutate(LONG_WGS = st_coordinates(.)[,1], 
         LAT_WGS = st_coordinates(.)[,2]) 

OUTPUT <- filter(OUTPUT, !ID %in% c(976, 393, 26))
# op <- st_intersection(OUTPUT, filter(st, STUSPS == 'MT'))

ggplot() +  
  geom_sf(data = OUTPUT, aes(color = OutlierFlag)) +
  geom_sf_text(data = OUTPUT, aes(label = ID)) +
  geom_sf(data = st, fill = NA) 

leaflet(data = OUTPUT) %>% 
   addTiles() %>%
   addMarkers(~LONG_WGS, ~LAT_WGS,  popup = ~as.character(ID), label = ~as.character(ID))
```

Every single taxon was individually mapped, and had there records investigated

```{r}

# Helenium puberulum c(451, 550, 620, 533)
# Helianthus annuus # no error
# Heliomeris multiflora c(734, 964, 1016, 970, 996, 339, 342, 247, 341)
# Heliotropium curassavicum # no error
# Hemizonia congesta c(446, 365)
# Heterotheca grandiflora c(1, 2, 2003)
# Heterotheca villosa c(2720, 2634, 2707, 3528, 2745, 3097, 3321, 3232, 2617, 3452, 2659, 3088, 3495)
# Hilaria rigida c(399, 506, 1065, 284, 1095, 1036, 345, 253, 248, 255, 254, 241, 1113, 784, 225:226, 285:286, 228, 243, 227, 249, 827, 242, 341, 338, 340, 244, 337, 240)
# Hordeum brachyantherum # no errors
# Hymenoclea salsola # no errors
# Hyptis emoryi c(169, 789, 958, 10, 576, 899, 433)
# Ionactis alpina c(1598, 1665, 404, 738, 112, 110, 1609, 184, 115)
# Koeleria macrantha c(4757, 2920, 6612, 6320, 7487, 1153, 8028, 1151)
# Lasthenia gracilis c(704, 729, 1134, 651, 1109, 992, 562, 406, 537, 644)
# Layia glandulosa c(830, 1506, 51, 445, 31))
# Lepdium fremontii c(936, 154, 81, 220, 298, 182, 230, 851, 503, 156, 762, 27, 104:106, 582, 303, 209, 236, 527, 36, 734, 350, 449) 
# Lepidium lasiocarpum c(976, 393, 26, 27, 1234, 831, 1190, 1793, 733, 506, 1576, 931, 1157, 1283, 1267, 1408, 507, 1159, 859, 505, 642, 103, 25, 143, 145, 146, 395, 28, 392, 50, 51, 1125, 685, 789, 394, 158, 18, 35)
```










```{r Inspect Records for Each Taxon}
# Abronia villosa c(718, 662, 1103, 1047)
# Acamptopappus sphaerocephalus c(370, 42, 46, 57, 58, 80:92, 76, 75, 470)
# Achnatherum aridum c(5, 15)
# Achnatherum hymenoides # no error 
# Achnatherum lemmonii c(596, 573)
# Achnatherum occidentale  # no error
# Achnatherum speciosum c(118, 745)
# Achnatherum thurberianum c(3433, 549, 550, 801, 1137, 2811, 2443, 2308, 2020, 2309, 2310, 2312, 3400, 2313, 2442, 2368, 2311, 3261, 2749, 2750)
# Acmispon americanus # NO ERRORS
# Acmispon humistratus # need name updating!!!!!!
# Acmispon rigidus c(385, 55)
# Acmispon strigosus c(1469)
# Agoseris glauca # NO ERRORS
# Agoseris parviflora # NO ERRORS
# Alisma triviale # NO ERRORS
# Amaranthus fimbriatus # NO ERRORS

# Anisocoma acaulis c(518)
# Antirrhinum coulterianum # NO ERROR
# Agoseris grandiflora c(638, 863)
# Asclepias albicans c(1, 50, 265, 284)
# Asclepias cordifolia c(2, 3, 5, 609)
# Asclepias cryptoceras, c(238, 303, 35:49)
# A. eriocarpa c(788, 920, 857, 289, 639)
# Asclepias fascicularis c(1813, 21, 26, 17, 22, 31, 25, 19)
# Asclepias erosa c(2)
# A. solanoana # NO ERRORS
# A. subulata c(9, 12, 515)
# A. speciosa # NO ERROR
# Astragalus didymocarpus c(158)
# Astragalus eremiticus c(275, 280)
# A. filipes c(1703, 773, 1281, 1029:1031, )
# Astragalus layneae c(2, 7, 107, 265)
# A. iodanthus # NO ERRORS
# A. lonchocarpus c(9, 128, 372)
# A. whitneyi c(19, 36, 29)

# Atriplex hymenelytra c(20, 506, 558)
# Atriplex parryi c(5, 87)
# Atriplex polycarpa c(37, 61, 63, 65:66, 68:70, 72, 91:93, 96, 98, 100, 105, 106, 109, 110, 112, 115:117, 250, 273, 279, 369, 503, 507, 791, 852, 875
# Baileya multiradiata  c(126, 311, 239, 833, 702, 271, 326, 590, 1023)
# Balsamorhiza hookeri c(1150)
# Balsamorhiza sagitatta # NO ERRORS
# Balsamorhiza serrata c(278)
# Bebbia juncea c(55)
# Bidens frondosa # NO ERRORS
# Bouteloua aristidoides # c(595)
# Bouteloua barbata # NO ERRORS
# Bromus sitchensis C(28, 67, 149)
# Calamagrostis nutkaensis # NO ERRORS
# Calliandra eriophylla c(903, 811)
# Calycoseris parryi c(8)
# Camissonia strigulosa c(349, 538, 274, 495, 770, 145, 722, 29, 561, 418, 577, 656, 351, 662, 306)
# Carex nebrascensis c(723)
# Centromadia fitchii c(151, 227)
# Centromadia pungens c(82, 92, 39, 6, 104, 136, 47) # don't care about WA introduced material

# Cephalanthus occidentalis c(352, 311, 385)
# Chaenactis fremontii c(1457, 89, 270, 191, 21, 23, 159, 6, 1180, 171, 219:227, 4, 5, 160, 129, 158, 130, 10, 11, 131, 280, 20, 190, 215, 213, 128, 214, 320, 22, 202, 204, 203, 267, 268, 228:232) 
# Chaenactis glabriuscula c(90)
# Chaenactis stevioides c(2005, 1869, 1931)
# Chaenactis xantiana c(81)
# Chilopsis linearis c(318, 595, 847, 978, 764, 415, 1264, 1256, 910, 592, 866, 560, 172, 767, 547, 1567, 809, 1158, 763, 173, 548, 1155, 162, 1147, 460, 530, 800, 1379, 496, 823, 829, 808, 685, 856, 180, 585, 545, 830, 833, 821, 803, 796, 618, 502, 495, 500, 893, 791, 780, 517, 1377, 1338, 546, 588, 1062, 611, 1611, 1257, 1492, 1311, 867, 1637, 1310, 846, 1372, 968, 1635, 556, 550)
# Chylismia brevipes c(1, 4, 5, 65, 101, 105, 305, 407)
# Chylismia claviformis c(864, 955)
# Clarkia purpurea c(200, 881)
# Clarkia rhomboidea # NO ERRORS
# Cleome lutea c(76, 110, 299, 202)
# Cleome serrulata # no errors
# Collinsia concolor # no errors
# Collinsia grandiflora c(307, 147)
# Collinsia heterophylla c(1017, 1524, 273, 1567, 1105, 1056, 1504, 275, 1264)
# Coleogyne ramosissima c(232, 287, 286, 945, 300, 320, 150, 507, 1860, 2015, 467, 747, 2012, 382:389, 148, 149)
# Condalia globosa var. pubescens # no errors
# Cordylanthus rigidus c(25, 287, 248)
# Crepis acuminata c(6612, 6080, 2775, 5027, 5472, 1217, 5434, 6232, 6111, 6424, 5979, 4235, 4217, 6511, 3135,
                  #   5478, 5979, 2059, 2084:2085, 4784:4785, 5483:5484, 2078, 4793, 4790:5000, 5486, 5116:5121, 5480,
                  #   5456, 6419, 5481:5482, 5487:5488, 3136, 2070, 3419, 5959, 5479, 6203, 4781:4783, 2090, 5122:5123)
# Crepis occidentalis c(5663)
# Croton californicus c(1452, 759, 954, 740)
# Croton setiger # NO ERROR
# Cryptantha flavoculata c(25, 430, 431, 672, 587, 555, 303)
# Cryptantha intermedia c(1062, 81, 35, 995, 762, 1154)
# Cryptantha micrantha c(26, 411, 213)
# Crypantha nevadensis c(375, 463, 370, 453, 327)
# Cryptantha pterocarya c(850, 929)
# Cylindropuntia acanthocarpa var. acanthocarpa c(3)
# Cylindropuntia bigelovii c(321, 52, 4, 50, 51)
# Cylindropuntia ramosissima # NO ERRORS
# Cymopterus bulbosus c(120, 121, 141)
# Cymopterus purpureus c(327, 381, 283, 104, 98, 97, 99, 136)
# Dalea mollis c(591)
# Dalea ornata # NO ERROR
# Dalea searlsiae # NO ERROR
# Danthonia californica # no error
# Dasyochloa pulchella c(1231)
# Deschampsia cespitosa # NO ERROR
# Descurainia pinnata # no error
# Dichelostemma capitatum c(1, 5, 6, 7, 266)
# Dieteria canescens # NO ERROR
# Distichlis spicata # NO ERROR
# Dudleya cymosa c(745, 862)
# Dudleya farinosa c(474, 500)
# Echinocereus engelmannii C(163, 368, 330, 181)
# Eleocharis macrostachya c(548, 642, 661, 666)
# Elymus elymoides # no errors
# Elymus glaucus # no errors
# Elymus multisetus # no errors
# Encelia actoni # no errors
# Encelia virginensis # c(399)
# Ephedra californica c(581, 583)
# Ephedra nevadensis c(649, 3319)

# Epilobium brachycarpum # no errors
# Epilobium ciliatum # no errors
# Epilobium densiflorum # no errors
# Eremothera refracta c(74, 321)
# Ericameria cooperi c(125, 106, 117, 98, 100, 88, 83, 115, 78, 3, 91, 80, 89, 121, 94, 90, 85, 71, 113, 96, 114)
# Ericameria laricifolia c(5, 62, 11, 177, 459, 266, 314, 494, 575, 495)
# Ericameria teretifolia c(1, 5:7, 17:18, 23:56, 59:64, 68:79, 272, 160)
# Erigeron aphanactis c(650, 667, 624, 920, 702, 567)
# Erigeron bloomeri c(939, 934, 780, 959)
# Erigeron breweri c(106)
# Erigeron canadensis # no errors
# Erigeron divergens # no errors
# Erigeron linearis c(137, 743:759, 1952, 1206, 741:742, 1048:1050, 1051:1054, 756, 747, 939)
# Erigeron pumilus c(2344, 2395)
# Erigeron speciosus c(1609, 23, 1672, 69)
# Eriogonum cernuum c(737, 315, 940, 874, 795, 538, 861, 863, 316, 654, 982, 974, 887, 758, 970, 426, 994, 815))
# Eriogonum fasciculatum c(5574, 5312, 172, 3, 256, 524, 4644, 2674)
# Eriogonum fasciculatum var. polifolium c(781, 232, 991, 856)
# Eriogonum fusiforme # NO ERRORS
# Eriogonum heracleoides c(1826, 1644, 1952, 795, 1881, 525, 1157, 1162, 1429, 1428, 1159, 1455, 1457, 1430, 1438,1450, 1458, 1435, 1448, 1443, 1459, 190, 1196, 1444, 1418, 1198, 1203, 1400:1427, 1134:1141, 1144:1149, 1399, 1398, 1144, 1397, 1434, 793, 1707, 1505, 1860, 1206, 1771, 1510, 1478, 1704, 1378)
# Eriogonum inflatum c(2173, 2263)
# Eriogonum latifolium c(1, 2, 646, 558, 633, 604, 520, 538, 576, 623, 559, 592, 606, 574, 560, 619, 416)
# Eriogonum microthecum c(2263, 1516, 1534, 1038, 2462, 2456, 2186, 1513, 1514, 2448)
# Eriogonum ovalifolium c(4225, 3322, 1421:1428, 4235)
# Eriogonum shockleyi c(8, 9, 10, 20, 336, 26)
# Eriogonum strictum c(729, 553, 583, 582, 703, 320, 131)
# Eriogonum umbellatum c(1071, 1068, 5718)
# Eriophyllum lanatum c(1925, 1766, 1769, 1102, 625, 636, 648, 39)
# Eriophyllum wallacei c(496, 515, 862)
# Eryngium aristulatum c(37, 30, 53)
# Erythranthe guttata # NO ERRORS
# Euphorbia albomarginata c(375)
# Euphorbia micromera c(290, 145, 361)
# Euphorbia polycarapa c(1479, 1416, 1199, 857, 1135)
# Euthamia occidentalis c(773)

# Ferocactus cylindraceus c(84, 2890)
# Festuca idahoensis c(6333, 3483, 6144, 6077, 6209, 6526, 6103, 6792, 6007, 6298)
# Fourquieria splendens # no errors
# Fraxinus anomala c(785, 127)
# Fraxinus latifolia c(788, 476, 72, 806)
# Fraxinus velutina c(793, 877, 952, 656, 154, 586, 505, 194, 749, 125, 685, 784, 129, 196, 61, 332, 926, 796, 826, 256, 753, 808, 740, 417, 565, 689)
# Galium aparine # NO ERRORS
# Gereae canescens c(247, 45, 46)
# Glycyrrhiza lepidota # NO ERRORS
# Grindelia camporum c(295, 92, 212)
# Grindelia stricta c(1, 2)
# Gutierrezia microcephala c(36, 143, 21, 156, 1, 204, 1243, 1127, 762, 551, 975, 157, 7, 894, 153, 251, 53, 2, 250, 6, 914, 634, 1145, 85, 51, 43, 44, 739, 530:531, 714) 

# Triteleia laxa C(2016)
```




```{r load occurrence records}
thinned <- st_read('../data/raw/occurrence/thinned/thinned_occurrences.shp', quiet = TRUE)
st <- tigris::states() %>% 
    filter(DIVISION %in% c(8, 9), ! STUSPS %in% c('AK', 'HI')) %>% st_transform(4326) 
```

```{r load nifc}

```

```{r extract most recent fire}

```

```{r identify similar plots}

```

```{r prepare data for modelling}

```

```{r model}

```

```{r evaluate models}

```

```{r export model summaries}

```

```{r subset occurrence records to reflect fire history}

```

